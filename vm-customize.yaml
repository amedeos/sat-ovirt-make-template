- name: Template Customization
  hosts: localhost
  become: false
  gather_facts: false
  vars_files:
    - variables-vault.yaml
    - variables.yaml
  tasks:
  - name: Add vm host
    add_host:
      name: "{{ engine_template.name }}"
      #ansible_ssh_private_key_file: ansible-ssh/id_rsa
      ansible_ssh_user: root
      ansible_password: "{{ vm_password }}"
      ansible_ssh_host: "{{ template.ip }}"
      groups:
        - templaterhv
    changed_when: False

- name: Wait for the vm to be online
  hosts: templaterhv
  gather_facts: True
  vars_files:
    - variables-vault.yaml
    - variables.yaml
  tasks:

  - name: Write motd
    copy:
      dest: /etc/motd
      content: |
        Generated by Ansible
      owner: root
      group: root
      mode: '0644'

  - name: Check virtualization host
    shell: |
      systemd-detect-virt
    register: hypervisor
    changed_when: False

  - name: Install packages for RHV
    dnf:
      name: "{{ packages_to_install_rhv }}"
      state: present
    when: hypervisor.stdout == "kvm"

  - name: Install packages for VMware
    dnf:
      name: "{{ packages_to_install_vmware }}"
      state: present
    when: hypervisor.stdout == "vmware"

  - name: Install common packages
    dnf:
      name: "{{ packages_to_install }}"
      state: present

  - name: Ensure qemu-guest-agent is enabled
    systemd:
      name: qemu-guest-agent
      enabled: True
    when: hypervisor.stdout == "kvm"

  - name: Ensure vmtoolsd is enabled
    systemd:
      name: vmtoolsd
      enabled: True
    when: hypervisor.stdout == "vmware"

  - name: Disable firewalld
    systemd:
      name: firewalld
      enabled: False
      state: stopped

  - name: Disable SELinux - sysconfig
    selinux:
      state: disabled
      configfile: /etc/sysconfig/selinux

  - name: Disable SELinux - selinux
    selinux:
      state: disabled
      configfile: /etc/selinux/config

  - name: Set history date time
    copy:
      dest: /etc/profile.d/history.sh
      owner: root
      group: root
      mode: '0644'
      content: |
        export HISTTIMEFORMAT='%F %T  '

